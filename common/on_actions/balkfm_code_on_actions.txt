#################################################
# GREECE, BYZANTIUM, AND THE BALKANS ON_ACTIONS #
#################################################

on_monthly_pulse_country = {
	on_actions = {
		grefm_monthly_pulse
		byfzm_monthly_pulse
#		turkfm_monthly_pulse
		balkfm_monthly_pulse
#		yug_flavor_pulse
		mon_flavor_pulse
		ser_flavor_pulse
		bul_flavor_pulse
		rom_flavor_pulse
#		bos_flavor_pulse
#		alb_flavor_pulse
#		triu_flavor_pulse
		eocfm_monthly_pulse
		byzfm_chariot_pulse_1
		byzfm_chariot_pulse_2	
	}
}

############

balkfm_monthly_pulse = { # These events are monitored from all scopes
	events = {
		grefm.915 # Reassigns the Revolt Journals
		balkfm.020 # Places Yugoslav Secession Variable
		balkfm.208 # Yugoslavism Fizzles Out
		balkfm.598 # The Bulgarian State
		eqfm.009 # Adds je_eqfm_sub as appropriate
	}
}

############

# There's a lot of tiny on_actions specified here to avoid having more complicated triggers downstream in the events themselves

grefm_monthly_pulse = {
	trigger = {
		country_has_primary_culture = cu:greek 
	}
	events = {
		grefm.005 # error 404 monarch not found
		grefm.034 # unfortunately we are bankrupt
		grefm.040 # Military Nepotism
		grefm.101 # hellenic railways
		grefm.103 # greek shipping
		grefm.110 # decline of the heptanese school
		grefm.111 # lake kopais
		grefm.114 # Merchantile Rivalry
#		grefm.120 # olympics restarted
		grefm.121 # university of athens
		grefm.131 # the corinth canal
		grefm.132 # the royal palace
		grefm.201 # megali idea 2
		grefm.203 # thessaly reminder
		grefm.232 # Jonas King Returns
		grefm.260 # the fate of the turks
		grefm.263 # capital switch option
		grefm.264 # Greco-Roman relations
		grefm.900 # Re-Adds Trukish Culture
		grefm.901 # non-GRE claims
	}
	random_events = {
		200 = 0
		 5 = grefm.021 # a perennial problem
		 5 = grefm.032 # who is to blame
		 5 = grefm.100 # fix brewery
		 5 = grefm.102 # greek aviation
		 5 = grefm.122 # university of constantinople
		 5 = grefm.157 # The Mask of Agammemnon
		 5 = grefm.230 # The Defence of Jonas King
		25 = grefm.243 # greek identity completion
		25 = grefm.244 # history of the greek nation
		25 = grefm.261 # turkish homelands
		25 = grefm.262 # greek expansion	
		10 = grefm.902 # Don Pacifico Affair
	}
}

byfzm_monthly_pulse = {
	trigger = {
		has_global_variable = has_formed_byz
	}
	events = {
		byzfm.100 # Event beginning construction of Imperial Palace
		byzfm.123 # drag racing in the hippodrome
	}
	random_events = {
		100 = 0
		 1 = byzfm.311 # A Greek Basileus
	}
	effect = {
		if = {
			limit = {
				has_variable =  byzfm_held_chariot_races
			}
			change_variable = {
				name = byzfm_held_chariot_races
				add = -1
			}
			clamp_variable = { # just to avoid outlandish values
				name = byzfm_held_chariot_races
				max = 48 
				min = 0 
			}
		}
	}
}

mon_flavor_pulse = {
	trigger = {
		OR = {
			c:MON ?= this
		}
	}
	events = {
		balkfm.032 # Cleans up after balkfm.031
		balkfm.332 # Knives in the Dark
	}
	random_events = {
		100 = 0
		  5 = balkfm.030 # Creates Hersek with Smaïl-aga at the Helm
		  5 = balkfm.031 # Creates Hersek with Ali Pasha at the Helm
	}
}

ser_flavor_pulse = {
	trigger = {
		OR = {
			c:SER ?= this
			c:SRPS ?= this
		}
	}
	events = {
		balkfm.470 # Disruptive Influence
	}
	random_events = {
		100 = 0
	}
}

bul_flavor_pulse = {
	trigger = {
		OR = {
			c:BUL ?= this
			c:TSAR ?= this
		}
	}
	events = {
	}
	random_events = {
		100 = 0
	}
}

rom_flavor_pulse = {
	trigger = {
		OR = {
			c:WAL ?= this
			c:MOL ?= this
			c:TRS ?= this
			c:ROM ?= this
		}
	}
	events = {
		balkfm.660 # The Academy of Romania
		balkfm.673 # Echoes of the Empire
	}
	random_events = {
		100 = 0
	}
}

eocfm_monthly_pulse = {
	trigger = {
		country_has_state_religion = rel:orthodox
	}
	events = {
		eocfm.001 # Bishops of the East
		eocfm.310 # The Ancient Partiarchates
		eocfm.312 # The Capture of the Great Mosque
		eocfm.901 # Restores JE
	}
	random_events = {
		100 = 0
	}
}

############

# This pair of on_actions handle the chariot races

byzfm_chariot_pulse_1 = {
	trigger = {
		has_modifier = modifier_byzfm_chariot_racing
		has_variable = byzfm_held_chariot_races
		var:byzfm_held_chariot_races < 1
	}
	random_events = {
		20 = byzfm.110 # reds win
		20 = byzfm.111 # whites win
		20 = byzfm.112 # greens win
		20 = byzfm.113 # blues win
		10 = byzfm.116 # first match complete, crowd calls for diversum
		 1 = byzfm.117 # sporting riot
		 1 = byzfm.118 # ruler tries to join race
		 1 = byzfm.119 # team gets caught cheating
	}
}

byzfm_chariot_pulse_2 = {
	trigger = {
		has_modifier = modifier_byzfm_expanded_chariot_racing
		has_variable = byzfm_held_chariot_races
		var:byzfm_held_chariot_races < 1
	}
	random_events = {
		25 = byzfm.110 # reds win - industrialists
		25 = byzfm.111 # whites win - intel
		25 = byzfm.112 # greens win - rural folk
		25 = byzfm.113 # blues win - petite
		25 = byzfm.114 # purples win - landowners
		25 = byzfm.115 # golds win - trade unions
		15 = byzfm.116 # first match complete, crowd calls for diversum
		 5 = byzfm.117 # sporting riot
		 5 = byzfm.118 # ruler tries to join race
		 1 = byzfm.119 # team gets caught cheating
	}
}

############

#These on_actions are specifically to catch Bulgaria and create it as BUL & ERUM if possible

on_country_released_as_independent = {
	on_actions = {
		balkfm_release_pulse_1
	}
}

on_country_released_as_own_subject = {
	on_actions = {
		balkfm_release_pulse_2
	}
}

balkfm_release_pulse_1 = { # BUL keeps ERUM if fully independent
	effect = {
		if = {
			limit = {
				c:BUL ?= scope:target
				NOT = { has_global_variable = balkfm_lion_awakened }
			}
			scope:target = {
				balkfm_set_bulgarian_laws = yes
				balkfm_create_bulgarian_characters = yes
				trigger_event = {
					id = balkfm.500 # The Golden Lion Awakens
				}
			}
		}
	}
}

balkfm_release_pulse_2 = { # Splits BUL and ERUM if BUL is released as a subject
	effect = {
		if = {
			limit = {
				c:BUL ?= scope:target
				NOT = { has_global_variable = balkfm_lion_awakened }
			}
			scope:target = {
				balkfm_set_bulgarian_laws = yes
				balkfm_create_bulgarian_characters = yes
				trigger_event = {
					id = balkfm.500 # The Golden Lion Awakens
				}
			}
			if = {
				limit = {
					c:TUR = {
						owns_entire_state_region = STATE_NORTHERN_THRACE
					}
				}
				create_country = {
					tag = ERUM
					origin = this
					state = s:STATE_NORTHERN_THRACE.region_state:TUR
					on_created = {
					}
				}
				c:TUR ?= {
					create_diplomatic_pact = {
						country = c:ERUM
						type = puppet
					}
				}
			}
			else_if = {
				limit = {
					c:BUL = {
						owns_entire_state_region = STATE_NORTHERN_THRACE
					}
				}
				create_country = {
					tag = ERUM
					origin = this
					state = s:STATE_NORTHERN_THRACE.region_state:BUL
					on_created = {
					}
				}
				c:TUR ?= {
					create_diplomatic_pact = {
						country = c:ERUM
						type = puppet
					}
				}
			}
		}
	}
}

############

on_secession_start = {
	on_actions = {
		eqfm_secession_start
	}
}

eqfm_secession_start = {
	effect = {
		if = {
			limit = {
				has_journal_entry = je_eqfm_main
				scope:target = {
					balkfm_balkans_native_trigger = yes
				}
			}
		}
		eqfm_secession_start_effect = yes
	}		
}

############

on_wargoal_enforced = {
	on_actions = {
		eocfm_wargoal_enforced_1
		eocfm_wargoal_enforced_2
		eqfm_crisis_wargoal_enforced
#		eqfm_thunderdome_wargoal_enforced
	}
}

# These on_actions changes the Crusade target's state religion or penalize the Crusade initiator if they lose. The crusade variables are set by the Crusade DP. This is very janky, I agree.

eocfm_wargoal_enforced_1 = { # From the initiator, in the case of crusade success
	trigger = {
		has_variable = eocfm_crusade_initiator
		scope:target = {
			has_variable = eocfm_crusade_target
		}
	}
	effect = {
		remove_global_variable = eocfm_crusade_var
		every_country = {
			limit = {
				eocfm_crusade_participant_trigger = yes
			}
			trigger_event = {
				id = eocfm.061 # Victorious Crusade
			}
			eocfm_crusade_cleanup = yes
		}
	}
}

eocfm_wargoal_enforced_2 = { # From the target, in the case of crusade failure
	trigger = {
		has_variable = eocfm_crusade_target
		any_country = { # scope:initiator and scope:actor aren't available here, pdx pls
			has_variable = eocfm_crusade_initiator
		}
	}
	effect = {
		remove_global_variable = eocfm_crusade_var
		every_country = {
			limit = {
				eocfm_crusade_participant_trigger = yes
			}
			trigger_event = {
				id = eocfm.062 # Failed Crusade
			}
			eocfm_crusade_cleanup = yes
		}
	}
}

# These on_actions trigger after the Great Eastern Crisis ideally. DPs are janky enough that these could get effed by concurrent wars but it's what we have.

eqfm_crisis_wargoal_enforced = {
	trigger = {
		has_global_variable = eqfm_crisis_happened
		OR = {
			has_variable = eqfm_crisis_target
			has_variable = eqfm_crisis_initiator
		}
	}
	effect = {
		if = {
			limit = {
				has_variable = eqfm_crisis_initiator
				NOT = { has_global_variable = eqfm_berlin_congress_var }
			}
			every_country = {
				limit = {
					has_variable = eqfm_crisis_offered
					NOT = { has_variable = eqfm_congress_offered }
				}
				trigger_event = {
					id = eqfm.119 # The Treaty of San Stefano
				}
			}
			if = {
				limit = {
					NOT = { has_global_variable = eqfm_berlin_congress_var }
				}
				set_global_variable = {
					name = eqfm_berlin_congress_var
					value = 0
				}
			}
		}
		if = {
			limit = {
				has_variable = eqfm_crisis_target
				NOT = { has_variable = eqfm_congress_offered }
			}
			every_country = {
				limit = {
					has_variable = eqfm_crisis_offered
				}
				trigger_event = {
					id = eqfm.118 # The Porte Triumphant
				}
			}
			set_global_variable = eqfm_porte_triumphant_var
		}
	}
}